function interpolate(t,e,n){var i,a=e-t;if("linear"===n||"lin"==n)i=function(t){return a*t};else if("exp"===n)i=function(t){return Math.exp(t*Math.log(1+a))-1};else{if("log"!==n)throw"not supported: "+n;i=function(t){return a*Math.log(t+1)/Math.log(2)}}return function(e){return t+i(e)}}function toHex(t){var e=t.toString(16);return 1===e.length?"0"+e:e}function RGB(t,e,n,i){this.r=t,this.g=e,this.b=n,this.a="undefined"!=typeof i?i:1,this.push(t,e,n,this.a)}function HSL(t,e,n){this.h=t,this.s=e,this.l=n,this.push(t,e,n)}"undefined"!=typeof L&&(L.CanvasLayer=L.Class.extend({includes:[L.Mixin.Events,L.Mixin.TileLoader],options:{minZoom:0,maxZoom:28,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",zoomOffset:0,opacity:1,unloadInvisibleTiles:L.Browser.mobile,updateWhenIdle:L.Browser.mobile,tileLoader:!1},initialize:function(t){t=t||{},this.render=this.render.bind(this),L.Util.setOptions(this,t),this._canvas=this._createCanvas(),this._backCanvas=this._createCanvas(),this._ctx=this._canvas.getContext("2d"),this.currentAnimationFrame=-1,this.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},this.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame||function(t){clearTimeout(t)}},_createCanvas:function(){var t;t=document.createElement("canvas"),t.style.position="absolute",t.style.top=0,t.style.left=0,t.style.pointerEvents="none",t.style.zIndex=this.options.zIndex||0;var e="leaflet-tile-container leaflet-zoom-animated";return t.setAttribute("class",e),t},onAdd:function(t){this._map=t;var e=this._map._panes.tilePane,n=L.DomUtil.create("div","leaflet-layer");n.appendChild(this._canvas),n.appendChild(this._backCanvas),this._backCanvas.style.display="none",e.appendChild(n),this._container=n,t.dragging.enabled()&&t.dragging._draggable.on("predrag",function(){var e=t.dragging._draggable;L.DomUtil.setPosition(this._canvas,{x:-e._newPos.x,y:-e._newPos.y})},this),t.on({viewreset:this._reset},this),t.on("move",this.redraw,this),t.on("resize",this._reset,this),t.on({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.tileLoader&&this._initTileLoader(),this._reset()},_animateZoom:function(t){this._animating||(this._animating=!0);var e=this._backCanvas;e.width=this._canvas.width,e.height=this._canvas.height;this._canvas._leaflet_pos||{x:0,y:0};e.getContext("2d").drawImage(this._canvas,0,0),this._canvas.style.display="none",e.style.display="block";var n=this._map,i=(n.getZoomScale(t.zoom),n._latLngToNewLayerPoint(n.getCenter(),t.zoom,t.center)),a=n._latLngToNewLayerPoint(t.center,t.zoom,t.center),o={x:i.x-a.x,y:i.y-a.y},r=e,s=L.DomUtil.TRANSFORM;r.style[s]=L.DomUtil.getTranslateString(o)+" scale("+t.scale+") "},_endZoomAnim:function(){this._animating=!1,this._canvas.style.display="block",this._backCanvas.style.display="none"},getCanvas:function(){return this._canvas},getAttribution:function(){return this.options.attribution},draw:function(){return this._reset()},onRemove:function(t){this._container.parentNode.removeChild(this._container),t.off({viewreset:this._reset,move:this._render,resize:this._reset,zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this)},addTo:function(t){return t.addLayer(this),this},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},setZIndex:function(t){this._canvas.style.zIndex=t},bringToFront:function(){return this},bringToBack:function(){return this},_reset:function(){var t=this._map.getSize();this._canvas.width=t.x,this._canvas.height=t.y;var e=L.DomUtil.getPosition(this._map.getPanes().mapPane);e&&L.DomUtil.setPosition(this._canvas,{x:-e.x,y:-e.y}),this.onResize(),this._render()},_updateOpacity:function(){},_render:function(){this.currentAnimationFrame>=0&&this.cancelAnimationFrame.call(window,this.currentAnimationFrame),this.currentAnimationFrame=this.requestAnimationFrame.call(window,this.render)},redraw:function(t){var e=L.DomUtil.getPosition(this._map.getPanes().mapPane);e&&L.DomUtil.setPosition(this._canvas,{x:-e.x,y:-e.y}),t?this.render():this._render()},onResize:function(){},render:function(){throw new Error("render function should be implemented")}})),"undefined"!=typeof L&&"undefined"!=typeof L.CanvasLayer&&(RGB.prototype=new Array,RGB.fromHex=function(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i.exec(t);return new RGB(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),"undefined"!=typeof e[4]?parseInt(e[4],16)/255:void 0)},RGB.prototype.hsl=function(){var t,e,n=this.r/255,i=this.g/255,a=this.b/255,o=Math.max(n,i,a),r=Math.min(n,i,a),s=(o+r)/2;if(o===r)t=e=0;else{var h=o-r;switch(e=s>.5?h/(2-o-r):h/(o+r),o){case n:t=(i-a)/h+(a>i?6:0);break;case i:t=(a-n)/h+2;break;case a:t=(n-i)/h+4}t/=6}return new HSL(t,e,s)},RGB.prototype.hex=function(){return"#"+toHex(this.r)+toHex(this.g)+toHex(this.b)},RGB.prototype.rgba=function(){return"rgba("+this.join(",")+")"},RGB.prototype.opacity=function(t){return new RGB(this.r,this.g,this.b,t)},RGB.prototype.opacify=function(t){return new RGB(this.r,this.g,this.b,this.a*t)},RGB.prototype.interpolate=function(t,e){var n=this.hsl(),i=t.hsl(),a=n.map(function(t,n){return t+e*(i[n]-t)}),o=this.a+e*(t.a-this.a);return new HSL(a[0],a[1],a[2]).rgb().opacity(o)},HSL.prototype=new Array,HSL.prototype.rgb=function(){var t,e,n,i=this.h,a=this.s,o=this.l;if(0===a)t=e=n=o;else{var r=function(t,e,n){return 0>n&&(n+=1),n>1&&(n-=1),1/6>n?t+6*(e-t)*n:.5>n?e:2/3>n?t+(e-t)*(2/3-n)*6:t},s=.5>o?o*(1+a):o+a-o*a,h=2*o-s;t=r(h,s,i+1/3),e=r(h,s,i),n=r(h,s,i-1/3)}return new RGB(Math.round(255*t),Math.round(255*e),Math.round(255*n))},L.SolrHeatmapLayer=L.CanvasLayer.extend({options:{field:"geo",query:{q:"*:*"},blur:10,opacity:.5,colors:["00ff00","ff0000"],interp:"linear"},initialize:function(t,e){L.CanvasLayer.prototype.initialize.apply(this,[e]),this.url=t},onAdd:function(t){L.CanvasLayer.prototype.onAdd.apply(this,[t]);var e=this;t.on("zoomstart",function(){e.clear()})},fetch:function(t,e){var n=this,i=this.url+"/select?",a=this.options.query;for(var o in a)i+=o+"="+a[o]+"&";i+="rows=0&facet=true&facet.heatmap="+this.options.field+"&facet.heatmap.geom=["+Math.max(-180,t.getWest())+" "+Math.max(-90,t.getSouth())+" TO "+Math.min(180,t.getEast())+" "+Math.min(90,t.getNorth())+"]&facet.heatmap.format=ints2D&wt=json";var r=new XMLHttpRequest;r.open("GET",encodeURI(i)),r.onload=function(){if(200!=r.status)throw"heatmap call failed";var t=JSON.parse(r.responseText),i=t.facet_counts.facet_heatmaps[n.options.field];hm={};for(var a=0;a<i.length-1;a+=2)hm[i[a]]=i[a+1];hm.data=hm.counts_ints2D,e.apply(n,[hm])},r.send()},clear:function(t){var e=this.getCanvas(),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)},renderGrid:function(t){var e=this._map,n={ul:e.latLngToContainerPoint({lng:t.minX,lat:t.maxY}),lr:e.latLngToContainerPoint({lng:t.maxX,lat:t.minY})};n.width=n.lr.x-n.ul.x,n.height=n.lr.y-n.ul.y;var i=this.getCanvas(),a=i.getContext("2d");a.strokeStyle="rgb(0,255,0)",a.strokeRect(n.ul.x,n.ul.y,n.width,n.height)},render:function(){var t=this.getCanvas(),e=t.getContext("2d");null!==this.throttle&&clearTimeout(this.throttle),this.clear();var n=this;this.throttle=setTimeout(function(){var i=n._map;n.fetch(i.getBounds(),function(a){if(n.clear(),null!==a.data){n.computeStats(a);var o=interpolate(0,1,n.options.interp),r=(a.maxX-a.minX)/a.columns,s=(a.maxY-a.minY)/a.rows;t.style.webkitFilter="blur("+n.options.blur+"px)";for(var h=n.options.opacity,l=RGB.fromHex(n.options.colors[0]),c=RGB.fromHex(n.options.colors[1]),m=a.maxY,u=0;u<a.rows;u++){var d=a.data[u];if(null!=d)for(var p=a.minX,f=0;f<a.columns;f++){var y=i.latLngToContainerPoint({lng:p,lat:m}),v=i.latLngToContainerPoint({lng:p+r,lat:m-s}),g=o(a.data[u][f]/a.max);if(g>0){var _=l.interpolate(c,g);_=_.opacify(h),e.fillStyle=_.rgba(),e.fillRect(y.x,y.y,v.x-y.x,v.y-y.y)}p+=r}m-=s}}})},200)},computeStats:function(t){for(var e=-Number.MIN_VALUE,n=Number.MAX_VALUE,i=0;i<t.data.length;i++){var a=t.data[i];null!=a&&(e=Math.max(e,Math.max.apply(null,a)),n=Math.min(n,Math.min.apply(null,a)))}t.max=e,t.min=n}}));